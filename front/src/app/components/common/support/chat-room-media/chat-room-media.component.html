<aside class="chat-room-media">
  <section class="chat-room-media__chat-room-info">
    <h3 class="chat-room-media__local-stream-title">
      Peers list
    </h3>
    <ul class="chat-room-media__users-list">
      @for(user of usersList(); let index = $index; track index){
      <li class="chat-room-media__user
        {{user === ownUsername() ? 'chat-room-media__user--is-ourselves' : ''}}
        {{ user !== ownUsername() && user === otherPeerUserName && !webRtcSessionStarted ? 'chat-room-media__user--room-remote-peer' : ''}}
        {{ user !== ownUsername() && user === otherPeerUserName && webRtcSessionStarted ? 'chat-room-media__user--connected-remote-peer' : ''}}
        ">
        <p class="chat-room-media__username">
          {{user === ownUsername() ? user + ' (you)' : user}}
        </p>
      </li>
      }
    </ul>

    <h3 class="chat-room-media__local-stream-title">
      Awaiting calls
    </h3>

    <ul class="chat-room-media__calls-list">
      <li class="chat-room-media__calls-item chat-room-media__calls-item--create-room">
        <button type="button" class="chat-room-media__button ycyw__button ycyw__button--1" (click)="createRoom()"
          [disabled]="currentRoom()"><mat-icon>add_circle</mat-icon></button>
      </li>
      @for(room of roomsList(); let index = $index; track index){
      <li class="chat-room-media__calls-item">
        <p class="chat-room-media__room-name">
          Call from: <strong>{{ room.roomName }} {{room.roomName === ownUsername() ? '(own room)' : ''}}</strong>
        </p>

        @if(currentRoom() && otherPeerUserName && !webRtcSessionStarted && (hasRemotePeerSharedWebCam() ||
        hasRemotePeerSharedMicrophone()) &&
        localPeerHasSharedLocalMedia()){
        @if(isReceiver){
        <span class="chat-room-media__remote-peer-info">Waiting for room creator to start the WebRTC session</span>
        }@else{
        <span class="chat-room-media__remote-peer-info">You can start the WebRTC session</span>
        }
        }

        <p class="chat-room-media__room-info">
          @if(currentRoom() && otherPeerUserName && !webRtcSessionStarted){

          <span
            class="chat-room-media__remote-peer-info {{!hasRemotePeerSharedWebCam() && !hasRemotePeerSharedMicrophone() ? 'chat-room-media__element--outline' : ''}}">
            Remote peer shared:
            @if(hasRemotePeerSharedMicrophone()){
            <mat-icon>mic</mat-icon>
            }@else {
            <mat-icon>mic_off</mat-icon>
            }

            @if(hasRemotePeerSharedWebCam()){
            <mat-icon>videocam</mat-icon>
            }@else {
            <mat-icon>videocam_off</mat-icon>
            }

          </span>
          }

          <button type="button"
            class="chat-room-media__room-button chat-room-media__{{currentRoom() ? 'has-joined' : 'no-join'}} {{room.isFull ? 'chat-room-media__join-button--is-full' : 'chat-room-media__join-button'}}"
            (click)="connectToRoom(room.roomName)"
            [disabled]="room.roomName === ownUsername() || currentRoom() || room.isFull">
            @if(room.roomName === ownUsername()){
            @if(otherPeerUserName){

            Other peer joined: {{otherPeerUserName}}
            }@else {
            Waiting joiner
            }
            }@else {
            {{room.isFull ? 'Full' :
            'Join'}}
            }
          </button>
        </p>

      </li>
      }

    </ul>

    <div class="chat-room-media__room-buttons-container">
      @if(currentRoom()){
      <button type="button" class="chat-room-media__button ycyw__button ycyw__button--2"
        (click)="currentRoom() === ownUsername() && !isReceiver ? deleteRoom() : disconnectFromRoom()"
        [disabled]="!currentRoom()">
        @if(webRtcSessionStarted){
        <mat-icon>call_end</mat-icon>
        }@else {
        <mat-icon>phone_disabled</mat-icon>
        }
      </button>


      @if(!isReceiver && !webRtcSessionStarted){
      <button type="button"
        class="chat-room-media__button ycyw__button ycyw__button--1 {{ !localPeerHasSharedLocalMedia() || (!hasRemotePeerSharedWebCam() && !hasRemotePeerSharedMicrophone()) ? 'chat-room-media__element--outline' : ''  }}"
        (click)="initializeConnection()"
        [disabled]="!otherPeerUserName || !isRemotePeerMediaActive || !localPeerHasSharedLocalMedia()">
        <mat-icon>phone_callback</mat-icon>
      </button>
      }
      }

    </div>


    @if(roomErrorMessage){
    <p class="chat-room-media__error-message">
      An unexpected error occurred in room: {{roomErrorMessage}}
    </p>
    }
  </section>


  <!-- * Peer-to-peer stream (local and remote media streams) -->
  <section class="chat-room-media__peer-to-peer-stream">
    <h3 class="chat-room-media__local-stream-title">
      Local stream {{!webRtcSessionStarted ? "(preview)" : ""}}
    </h3>

    <div class="chat-room-media__local-media-container">
      <video autoPlay playsInline disablePictureInPicture #ownWebCamVideoRef
        class="chat-room-media__webcam-video chat-room-media__webcam-video--local"></video>

      <progress value="0" max="0.25" #ownAudioVolumeIndicatorRef class="chat-room-media__audio-indicator"></progress>
    </div>

    <app-collapsible-height [isOpen]="webRtcSessionStarted">
      <h3 class="chat-room-media__remote-stream-title">
        Remote stream
      </h3>
      <div class="chat-room-media__remote-media-container">

        <app-collapsible-height [isOpen]="hasRemotePeerSharedWebCam() && webRtcSessionStarted">
          <video autoPlay playsInline #remoteWebCamVideoRef
            class="chat-room-media__webcam-video chat-room-media__webcam-video--remote {{hasRemotePeerSharedScreen() ? 'chat-room-media__webcam-video--has-screen' : ''}}"></video>

          @if (hasPiPModeAvailable() && webRtcSessionStarted){
          <button (click)="requestPictureInPicture()">PiP</button>

          <label>
            <input type="checkbox" name="" [checked]="isPiPToggleEnabledOnTabSwitch()"
              (click)="togglePiPOnTabSwitch()" />
            Remove Picture-in-picture on current tab switch
          </label>
          }
        </app-collapsible-height>

        <app-collapsible-height [isOpen]="hasRemotePeerSharedMicrophone() && webRtcSessionStarted">
          <progress value="0" max="0.25" #remotePeerAudioVolumeIndicatorRef
            class="chat-room-media__audio-indicator"></progress>
        </app-collapsible-height>
      </div>

      @if(hasRemotePeerSharedScreen()){

      <button type="button" class="chat-room-media__webcam-video-fullscreen"
        (click)="requestRemoteScreenShareFullscreen()">Toggle fullscreen</button>
      }

      <p>{{otherPeerUserName}} {{hasRemotePeerSharedScreen() ? "is sharing their screen" : ""}}</p>
    </app-collapsible-height>



  </section>

  <!-- * Local webcam, audio and screen cast -->
  <section class="chat-room-media__local-stream">
    <p class="chat-room-media__error-message">
      @if(hasWebcamPermissionDenied()){
      <span class="chat-room-media__error-message--span">Webcam permission has been denied</span>
      }

      @if(hasMicrophonePermissionDenied()){
      <span class="chat-room-media__error-message--span">Microphone permission has been denied</span>
      }
    </p>



    <form class="chat-room-media__controls">

      <fieldset class="chat-room-media__controls-fieldset chat-room-media__controls-fieldset--toggles">
        <!-- * Webcam -->
        <div
          class="chat-room-media__icon chat-room-media__icon--{{(!webRtcSessionStarted && showWebcam()) || (webRtcSessionStarted && hasEnabledWebcamForWebRTC()) ? 'on' : 'off'}} {{ currentRoom() && !localPeerHasSharedLocalMedia() ? 'chat-room-media__element--outline' : ''  }}">
          <label class="chat-room-media__icon-checkbox">
            <input type="checkbox" name="local-connection-control" class="chat-room-media__input hide"
              (change)="webRtcSessionStarted ? toggleInputDevicesOnWebRtc($event, 'webcam') : toggleWebcam($event)"
              [checked]="showWebcam() || (webRtcSessionStarted && hasEnabledWebcamForWebRTC())" />
            @if((showWebcam() && !webRtcSessionStarted) || (webRtcSessionStarted && hasEnabledWebcamForWebRTC())){
            <mat-icon>videocam</mat-icon>
            }@else {
            <mat-icon>videocam_off</mat-icon>
            }
          </label>

          <label class="chat-room-media__icon-select-label">
            <mat-icon>keyboard_arrow_down</mat-icon>

            <select class="chat-room-media__input-device-select chat-room-media__input-device-select--video transparent"
              (change)="switchWebcamDevice($event)"
              [disabled]="!showWebcam() || (webRtcSessionStarted && !hasEnabledWebcamForWebRTC()) || hasNoVideoInputsInList()">

              @for(device of videoInputsList(); let index = $index; track index){
              <option value="{{device.deviceId}}" selected="{{index === 0}}">{{device.label}}</option>
              }

            </select>
          </label>
        </div>

        <!-- * Microphone -->
        <div
          class="chat-room-media__icon chat-room-media__icon--{{(!webRtcSessionStarted && openMicrophone()) || (webRtcSessionStarted && hasEnabledMicrophoneForWebRTC()) ? 'on' : 'off'}} {{ currentRoom() && !localPeerHasSharedLocalMedia() ? 'chat-room-media__element--outline' : ''  }}">

          <label class="chat-room-media__icon-checkbox">
            <input type="checkbox" name="local-connection-control" class="chat-room-media__input hide"
              (change)="webRtcSessionStarted ? toggleInputDevicesOnWebRtc($event, 'microphone') : toggleAudio($event)"
              [checked]="openMicrophone() || (webRtcSessionStarted && hasEnabledMicrophoneForWebRTC())" />
            @if((openMicrophone() && !webRtcSessionStarted) || (webRtcSessionStarted &&
            hasEnabledMicrophoneForWebRTC())){
            <mat-icon>mic</mat-icon>
            }@else {
            <mat-icon>mic_off</mat-icon>
            }
          </label>

          <label class="chat-room-media__icon-select-label">
            <mat-icon>keyboard_arrow_down</mat-icon>

            <select class="chat-room-media__input-device-select chat-room-media__input-device-select--audio transparent"
              (change)="switchMicrophoneDevice($event)"
              [disabled]="!openMicrophone() || hasNoAudioInputsInList() || (webRtcSessionStarted && !hasEnabledMicrophoneForWebRTC())">
              @for(device of audioInputsList(); let index = $index; track index){
              <option value="{{device.deviceId}}" [selected]="device.isDefaultDevice">{{device.label}}</option>
              }
            </select>
          </label>
        </div>


        <!-- * Speaker -->
        <div class="chat-room-media__icon chat-room-media__icon--{{ hasNoAudioOutputsInList() ? 'off' : 'on'}}">
          <label class="chat-room-media__icon-checkbox">
            <mat-icon>speaker</mat-icon>
          </label>

          <label class="chat-room-media__icon-select-label" (change)="switchSpeakerDevice($event)">
            <mat-icon>keyboard_arrow_down</mat-icon>

            <select
              class="chat-room-media__output-device-select chat-room-media__output-device-select--audio transparent"
              name="audio-output-device" [disabled]="hasNoAudioOutputsInList()">
              @for(device of audioOutputsList(); let index = $index; track index){
              <option value="{{device.deviceId}}" [selected]="device.isDefaultDevice">{{device.label}}</option>
              }
            </select>
          </label>
        </div>


        <!-- * Screen share -->
        <div
          class="chat-room-media__icon chat-room-media__icon--{{ webRtcSessionStarted && !hasEnabledWebcamForWebRTC() ? 'off' : 'on'}}">
          <label class="chat-room-media__icon-checkbox">
            <input type="checkbox" name="local-connection-control" class="chat-room-media__input hide"
              (change)="showScreenCast() ? stopScreenCast() : startScreenCast()" [checked]="showScreenCast()"
              [disabled]="!hasEnabledWebcamForWebRTC()" />

            @if(webRtcSessionStarted && hasEnabledWebcamForWebRTC()){
            @if(showScreenCast()){
            <mat-icon>desktop_access_disabled</mat-icon>
            }@else {
            <mat-icon>desktop_windows</mat-icon>
            }

            }@else {
            <mat-icon>phonelink_off</mat-icon>
            }
          </label>
        </div>



        <!-- * Screen recording -->
        <div class="chat-room-media__icon">
          <label class="chat-room-media__icon-checkbox chat-room-media__icon-checkbox--recording">
            <input type="checkbox" id="screen-record-toggle" class="chat-room-media__input hide"
              (change)="isRecording() ? stopRecording() : startRecording()" [checked]="isRecording()" />

            <span class="chat-room-media__recording-status-span">
              @if(isRecording()){
              <mat-icon
                class="chat-room-media__recording-status-icon chat-room-media__recording-status-icon--on">radio_button_checked</mat-icon>
              }
              <mat-icon class="chat-room-media__recording-status-icon">radio_button_checked</mat-icon>
            </span>
            REC
          </label>


          <label for="screen-record-toggle"
            class="chat-room-media__icon-select-label chat-room-media__icon-select-label--recording">
            @if(isRecording()){
            <mat-icon>stop</mat-icon> {{ formatDuration(screenRecordingElapsedTimeInSec()) }}
            }@else {
            <mat-icon>play_arrow</mat-icon>
            }
          </label>
        </div>

      </fieldset>

    </form>

  </section>

  <!-- * Screen recording -->
  <section class="chat-room-media__screen-recording">

    <app-collapsible-height [isOpen]="isRecording()">
      <video autoPlay playsInline #videoRecordingElementRef class="chat-room-media__screen-recording-preview"></video>
    </app-collapsible-height>


    <ul class="chat-room-media__screen-recording-list">

      @for (screenRecording of screenRecordingBlobs().reverse(); let index = $index; track index) {
      <li class="chat-room-media__screen-recording-item">
        <video src="{{screenRecording.objectUrl}}" controls class="chat-room-media__screen-recording-record"></video>

        <a download="screen-recording-{{index}}.webm" href="{{screenRecording.objectUrl}}">Download screen recording</a>
        <p>{{formatDuration(screenRecording.duration)}} ({{screenRecording.size}} bytes)</p>
        <button (click)="removeBlobFromListByIndex(index)">Delete screen recording</button>
      </li>
      }

    </ul>
  </section>




</aside>
