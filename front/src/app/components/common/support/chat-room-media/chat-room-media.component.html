<aside class="chat-room-media">
  <ul class="chat-room-media__users-list">
    <li class="chat-room-media__user">
      <p class="chat-room-media__username">
        {{ownUsername()}}
      </p>
    </li>
    @for(user of usersList(); let index = $index; track index){
    @if(user !== ownUsername()){
    <li class="chat-room-media__user">
      <p class="chat-room-media__username">
        {{user}}
      </p>
    </li>
    }
    }
  </ul>

  <ul class="chat-room-media__calls-list">
    <h3 class="chat-room-media__local-stream-title">
      Awaiting calls
    </h3>
    @if(!roomsList().length){
    <p>No calls have been made yet</p>
    }

    @for(room of roomsList(); let index = $index; track index){
    <li class="chat-room-media__calls-item">
      Incoming call request from: {{room.roomName}}
      <button type="button"
        class="ycyw__button ycyw__button--2 chat-room-media__{{currentRoom() ? 'has-joined' : 'no-join'}} chat-room-media__join-button{{room.isFull ? '--is-full' : ''}}"
        (click)="connectToRoom(room.roomName)"
        [disabled]="room.roomName === ownUsername() || currentRoom() || room.isFull">
        {{room.isFull ? 'Full' :
        'Join'}}
      </button>
    </li>
    }

  </ul>

  @if(roomErrorMessage){
  <p class="chat-room-media__error-message">
    An unexpected error occurred in room: {{roomErrorMessage}}
  </p>
  }

  <section class="chat-room-media__local-stream">
    <h3 class="chat-room-media__local-stream-title">
      Local stream
    </h3>

    <ul class="chat-room-media__devices-list">

    </ul>

    <p class="chat-room-media__error-message">
      @if(hasWebcamPermissionDenied()){
      <span class="chat-room-media__error-message--span">Webcam permission has been denied</span>
      }

      @if(hasMicrophonePermissionDenied()){
      <span class="chat-room-media__error-message--span">Microphone permission has been denied</span>
      }

      @if(hasCanceledScreenCast()){
      <span class="chat-room-media__error-message--span">Screen cast has been canceled</span>
      }

    </p>

    <video autoPlay playsInline muted volume="0" #ownWebCamVideoRef
      class="chat-room-media__webcam-video chat-room-media__webcam-video--local"></video>

    <form class="chat-room-media__controls">

      <fieldset class="chat-room-media__controls-fieldset chat-room-media__controls-fieldset--toggles">

        @if(webRtcSessionStarted){
        <legend class="chat-room-media__controls-legend chat-room-media__controls-legend--toggles">Toggle controls
          (WebRTC session on)
        </legend>
        <label class="chat-room-media__label chat-room-media__control">
          <input type="checkbox" name="local-connection-control webcam" class="chat-room-media__input"
            (change)="toggleInputDevicesOnWebRtc($event)" [checked]="showWebcam()" />
          {{ showWebcam() ? "Disable webcam" : "Enable webcam" }}
        </label>

        <label class="chat-room-media__label chat-room-media__control">
          <input type="checkbox" name="local-connection-control microphone" class="chat-room-media__input"
            (change)="toggleInputDevicesOnWebRtc($event)" [checked]="openMicrophone()" />
          {{ openMicrophone() ? "Disable audio" : "Enable audio" }}
        </label>
        }@else {
        <legend class="chat-room-media__controls-legend chat-room-media__controls-legend--toggles">Toggle controls
        </legend>
        <label class="chat-room-media__label chat-room-media__control">
          <input type="checkbox" name="local-connection-control" class="chat-room-media__input"
            (change)="toggleWebcam($event)" [checked]="showWebcam()" />
          {{ showWebcam() ? "Stop webcam" : "Start webcam" }}
        </label>

        <label class="chat-room-media__label chat-room-media__control">
          <input type="checkbox" name="local-connection-control" class="chat-room-media__input"
            (change)="toggleAudio($event)" [checked]="openMicrophone()" />
          {{ openMicrophone() ? "Stop audio" : "Start audio" }}
        </label>
        }


        <label class="chat-room-media__label chat-room-media__control">
          <input type="checkbox" name="local-connection-control" class="chat-room-media__input"
            (change)="toggleScreenCast($event)" [checked]="showScreenCast()" /> Screen
          cast</label>
      </fieldset>

      <fieldset class="chat-room-media__controls-fieldset chat-room-media__controls-fieldset--devices">
        <legend class="chat-room-media__controls-legend chat-room-media__controls-legend--devices">Device inputs/outputs
        </legend>
        <label class="chat-room-media__label chat-room-media__control">
          Video input device
          <select name="video-input-device" (change)="switchWebcamDevice($event)">
            @for(device of videoInputsList(); let index = $index; track index){
            <option value="{{device.deviceId}}" selected="{{device.isDefaultDevice}}">{{device.label}}</option>
            }
          </select>
        </label>
        <label class="chat-room-media__label chat-room-media__control">
          Audio input device
          <select name="audio-input-device" (change)="switchMicrophoneDevice($event)">
            @for(device of audioInputsList(); let index = $index; track index){
            <option value="{{device.deviceId}}" selected="{{device.isDefaultDevice}}">{{device.label}}</option>
            }
          </select>
        </label>
        <label class="chat-room-media__label chat-room-media__control" (change)="switchSpeakerDevice($event)">
          Audio output device
          <select name="audio-output-device">
            @for(device of audioOutputsList(); let index = $index; track index){
            <option value="{{device.deviceId}}" selected="{{device.isDefaultDevice}}">{{device.label}}</option>
            }
          </select>
        </label>

      </fieldset>

    </form>

  </section>

  <section class="chat-room-media__remote-stream">
    <h3 class="chat-room-media__remote-stream-title">
      Remote stream
    </h3>
    <video autoPlay playsInline #remoteWebCamVideoRef
      class="chat-room-media__webcam-video chat-room-media__webcam-video--remote"></video>
  </section>



  @if(!!(currentRoom())){
  @if(isReceiver){
  <button type="button" class="chat-room-media__button ycyw__button ycyw__button--2"
    (click)="disconnectFromRoom()">Disconnect from
    room</button>

  @if(!webRtcSessionStarted){
  @if(!localPeerHasSharedLocalMedia()){
  <p class="chat-room-media__error-message">You must share your local stream in to allow the other peer to start a
    WebRTC session</p>
  }


  @if(otherPeerUserName && !remotePeerHasSharedLocalMedia){
  <p class="chat-room-media__error-message">Waiting for other peer to share their stream</p>
  }
  }
  }@else {
  <button type="button" class="chat-room-media__button ycyw__button ycyw__button--2" (click)="deleteRoom()">Delete
    room</button>

  @if(!webRtcSessionStarted){
  <button type="button" class="chat-room-media__button ycyw__button ycyw__button--1" (click)="initializeConnection()"
    [disabled]="!otherPeerUserName || !remotePeerHasSharedLocalMedia || !localPeerHasSharedLocalMedia()">Start</button>
  }

  @if(!webRtcSessionStarted){
  <p class="chat-room-media__error-message">
    @if(!otherPeerUserName){
    <span class="chat-room-media__error-message--span">Waiting for other peer to join the room</span>
    }

    @if(!localPeerHasSharedLocalMedia()){
    <span class="chat-room-media__error-message--span">You must share your local stream in order to start a WebRTC
      session</span>
    }


    @if(!remotePeerHasSharedLocalMedia){
    <span class="chat-room-media__error-message--span">Waiting for other peer to share their stream</span>
    }

  </p>
  }

  }
  <!-- <button type="button" class="chat-room-media__button ycyw__button ycyw__button--1" (click)="sendTestMessage()">Send
    test message</button> -->
  } @else {

  <button type="button" class="chat-room-media__button ycyw__button ycyw__button--1" (click)="createRoom()"
    [disabled]="!!(currentRoom())">Create new
    room</button>
  }
</aside>